{% extends "_layout.html" %}

{% block title %}
  Market details for {{ snap_display_name }}
{% endblock %}

{% block content %}
  <div id="main-content" class="u-no-margin--top">
    {% set selected_tab='market' %}
    {% include "publisher/_header.html" %}

    <div class="p-strip is-shallow">
        <form id="market-form" method="POST" enctype='multipart/form-data'>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <input type="hidden" name="snap_id" value="{{ snap_id }}" />
          <input type="file" name="icon" id="snap_icon" hidden class="hidden" accept="image/*"/>

          <div class="row">
            <div class="col-12 u-align--right">
                <input type="submit" class="p-button--neutral" name="submit_revert" value="Revert"/>
                <input type="submit" class="p-button--positive" name="submit_apply" value="Apply"/>
                <hr />
            </div>
          </div>

          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages or error_list %}
              <div class="row">
                <div class="col-12">
                  {% for category, message in messages %}
                    <div id="market-form-status" class="p-notification--{{ category }}">
                      <p class="p-notification__response">
                          {{ message }}
                      </p>
                    </div>
                  {% endfor %}

                  {% for error in error_list %}
                    <div class="p-notification--negative">
                      <p class="p-notification__response">
                          {{ error.message }}
                      </p>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          {% endwith %}

          <div class="row">
            <div class="col-2">
              <div class="p-media-object__image--large p-editable-icon">
                <img id="snap_icon_image"
                  {% if icon_url %}
                    src="{{ icon_url }}" alt="{{ snap_display_name }} snap"
                  {% else %}
                    src="https://assets.ubuntu.com/v1/6fbb3483-snapcraft-default-snap-icon.svg" alt=""
                  {% endif %}
                />
              </div>
            </div>
            <div class="col-8">
              <label for="snap-title">Title:</label>
              <input id="snap-title" type="text" name="title" value="{{ snap_display_name }}"/>
            </div>
          </div>

          <div class="row">
            <div class="col-2">
              <label>Snap name: </label>
            </div>
            <div class="col-8">
                {{ snap_name }}
            </div>
          </div>

          <div class="row">
            <div class="col-2">
              <label>Publisher: </label>
            </div>
            <div class="col-8">
                {{ publisher_name }}
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <hr />
            </div>
          </div>

          <div class="row">
            <div class="col-2">
              <label class="p-label--grid-baseline">Summary: </label>
            </div>
            <div class="col-8">
              <input type="text" name="summary" value="{{ summary }}"/>
            </div>
          </div>
          <div class="row">
            <div class="col-2">
              <label class="p-label--grid-baseline">Description: </label>
            </div>
            <div class="col-8">
              <textarea class="u-no-margin" name="description">{{ description }}</textarea>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <hr />
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="p-screenshots-toolbar" id="screenshots-toolbar">
                <label>Screenshots (up to 5):</label>
                <div class="p-screenshots-toolbar__buttons">
                  <button class="p-button-neutral js-add-screenshots"><i class="p-icon--plus"></i></button>
                  <button class="p-button-neutral js-delete-screenshot"><i class="p-icon--delete"></i></button>
                  <button class="p-button-neutral js-fullscreen-screenshot  u-no-margin--top"><i class="p-icon--fullscreen"></i></button>
                </div>
              </div>
            </div>
          </div>

          <div id="snap-screenshots">
          </div>

          <div class="row">
            <div class="col-12">
              <hr />
            </div>
          </div>

          <div class="row">
            <div class="col-2">
              <label>License: </label>
            </div>
            <div class="col-8">
              {{ license }}
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <hr />
            </div>
          </div>

          <div class="row">
            <div class="col-2">
              <label class="p-label--grid-baseline">Developer website: </label>
            </div>
            <div class="col-8">
            <input type="text" name="website" value="{{ website }}"/>
            </div>
          </div>

          <div class="row">
            <div class="col-2">
              <label class="p-label--grid-baseline">Contact {{ publisher_name }}: </label>
            </div>
            <div class="col-8">
              <input type="text" name="contact" value="{{ contact }}"/>
            </div>
          </div>
        </form>
    </div>

    {% if api_error %}
    <div class="row">
      <div class="col-12">
        <div class="p-notification--negative">
          <p class="p-notification__response">
            <span class="p-notification__status">Error:</span> API request failed
          </p>
        </div>
      </div>
    </div>
    {% endif %}

  </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.ravenjs.com/3.22.3/raven.min.js" crossorigin="anonymous"></script>
<script src="/static/js/dist/publisher.js"></script>
<script>
  Raven.config('{{ SENTRY_PUBLIC_DSN }}', {
    whitelistUrls: ['snapcraft.io']
  }).install();
  Raven.context(function () {
    snapcraft.publisher.market.initSnapIconEdit("snap_icon_image", "snap_icon");
    snapcraft.publisher.market.initFormNotification("market-form", "market-form-status");
    snapcraft.publisher.market.initSnapScreenshotsEdit(
      "screenshots-toolbar",
      "snap-screenshots",
      {
        images: [
          {% if icon_url %}
            { url: {{ icon_url|tojson }}, type: "icon", status: "uploaded" },
          {% endif %}
          {% for screenshot_url in screenshot_urls %}
            { url: {{ screenshot_url|tojson }}, type: "screenshot", status: "uploaded" },
          {% endfor %}
        ]
      }
    );
  });
</script>
{% endblock %}
